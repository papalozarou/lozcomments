// -----------------------------------------------------------------------------
// lozcomments is a simple commenting system for HTML wireframes and design
// mock-ups. It uses Firebase (https://www.firebase.com/) to store data.
//
// ©2014 Loz Gray – Creative Commons Attribution Sharealike 3.0 Unported 
// http://creativecommons.org/licenses/by-sa/3.0/
//
// Dependancies:
//
// jquery 2.x.x
// lozcomments.css or lozcomments.min.css
// -----------------------------------------------------------------------------
var lozcomments=function(){function g(){y();u=$("[data-comments]");for(var e=u.length-1;e>=0;e--){var t=e+1,n=w(t),r=E(t);$(n).add($(r)).prependTo(u[e])}a=$(".lozcomments__anchor a");f=$(".lozcomments__wrapper");l=$(".lozcomments__thread");c=$(".lozcomments__form__submit");h=$(".lozcomments__form__cancel")}function y(){var r=document.title.replace(/\W/g,"-").toLowerCase();t=e+r+"-comments";n=new Firebase(t)}function b(e){var n="/"+e.closest("[data-comments]").data("comments"),i=t+n;r=new Firebase(i)}function w(e){var t='<figure class="lozcomments__anchor lozcomments__anchor-'+e+'">Comment<a href="#lozcomments__comments-'+e+'"></a></figure>';return t}function E(e){var t=S(e),n=x(e),r='<div id="lozcomments__comments-'+e+'" class="lozcomments__wrapper"><div class="lozcomments__pane">'+n+t+"</div></div>";return r}function S(e){var t='<input type="text" placeholder="Name" class="lozcomments__form__author lozcomments__form-'+e+'__author" />',n='<textarea rows="4" placeholder="Comment" class="lozcomments__form__message lozcomments__form-'+e+'__message" />',r='<input type="submit" class="lozcomments__form__submit lozcomments__form-'+e+'__submit" value="Comment" />',i='<input type="button" class="lozcomments__form__cancel lozcomments__form-'+e+'__cancel" value="Cancel" />',s='<form method="post" class="lozcomments__form lozcomments__form-'+e+'">'+t+n+r+i+"</form>";return s}function x(e){var t='<dl class="lozcomments__thread lozcomments__thread-'+e+'"></dl>';return t}function T(){s=$(window).width();if(s>=o)for(var e=a.length-1;e>=0;e--){var t=$(a[e]).parent(".lozcomments__anchor"),n=t.offset(),r=t.siblings(".lozcomments__wrapper");n.left>o-274?r.addClass(v).removeClass(m):r.addClass(m).removeClass(v)}else f.removeClass(v,m);i=s}function N(){$(window).resize(function(){i!==$(window).width()&&T()})}function C(){n.on("child_added",function(e){e.ref().on("child_added",function(e){var t=e.val(),n="#lozcomments__"+e.ref().parent().name()+" .lozcomments__thread",r=F(t.message);$(n).append('<dt class="lozcomment__author">'+t.author+"</dt>");$(n).append('<dd class="lozcomment__message">'+r+"</dd>")})})}function k(){a.click(function(e){L(this);e.preventDefault()})}function L(e){var t=$(".lozcomments__anchor--is-selected a"),n=e.hash;if(t[0])if($(e).parent().hasClass(p)){O();_()}else{O();A(e);M(n);D(n)}else{A(e);M(n);D(n)}}function A(e){$(e).parent().addClass(p);$(e.hash).addClass(d)}function O(){a.parent().removeClass(p)}function M(e){_();$(e).addClass(d)}function _(){f.removeClass(d)}function D(e){$(e).scrollTop($(e).prop("scrollHeight"))}function P(){c.click(function(e){b($(this));var t=$(this).siblings(".lozcomments__form__author"),n=$(this).siblings(".lozcomments__form__message"),i=t.val(),s=n.val();if(i!==""&&s!==""){t.removeClass("lozcomments__form__author--has-eror");n.removeClass("lozcomments__form__message--has-error");r.push({author:i,message:s})}else H(i,t,s,n);$(".lozcomments__form__author").val(i);n.val("");e.preventDefault()})}function H(e,t,n,r){if(e===""&&n===""){t.addClass("lozcomments__form__author--has-error");r.addClass("lozcomments__form__message--has-error")}else if(e===""){t.addClass("lozcomments__form__author--has-error");r.removeClass("lozcomments__form__message--has-error")}else if(n===""){t.removeClass("lozcomments__form__author--has-error");r.addClass("lozcomments__form__message--has-error")}}function B(){h.click(function(e){O();_();e.preventDefault()})}function j(){l.bind("mousewheel DOMMouseScroll",function(e){var t=e.originalEvent,n=t.wheelDelta||-t.detail;this.scrollTop+=(n<0?1:-1)*30;e.preventDefault()})}function F(e){var t=/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,n=/((www|(https?|ftp|file):\/\/)[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig,r=/(@([A-Za-z]+[A-Za-z0-9]+))/ig;e=e.replace(t,"$1<br />$2");e=e.replace(n,'<a href="$1" class="lozcomment__message-body__link">$1</a>');e=e.replace(r,'<mark class="lozcomment__message-body__mention">$1</mark>');return e}function I(){var e=window.location.search.substring(1).split("&");if($.inArray("lozcomments=off",e)>-1)return!1;g();T();C();k();P();B();j();N()}var e="https://blinding-fire-4499.firebaseio.com/",t,n,r,i=$(window).width(),s,o=640,u,a,f,l,c,h,p="lozcomments__anchor--is-selected",d="lozcomments__wrapper--is-active",v="lozcomments__wrapper--is-left",m="lozcomments__wrapper--is-right";return{checkSubstring:I}}();lozcomments.checkSubstring();