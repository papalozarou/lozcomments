// -----------------------------------------------------------------------------
// lozcomments is a simple commenting system for HTML wireframes and design
// mock-ups. It uses Firebase (https://www.firebase.com/) to store data.
//
// ©2014 Loz Gray – Creative Commons Attribution Sharealike 3.0 Unported 
// http://creativecommons.org/licenses/by-sa/3.0/
//
// Dependancies:
//
// jquery 2.x.x
// lozcomments.css
// -----------------------------------------------------------------------------
var lozcomments=function(){function m(){g();o=$("[data-comments]");for(var e=o.length-1;e>=0;e--){var t=$(o[e]).closest("[data-comments]").data("comments"),n=b(t),r=w(t);$(n).add($(r)).prependTo(o[e])}u=$(".lozcomments__anchor a");a=$(".lozcomments__wrapper");f=$(".lozcomments__thread");l=$(".lozcomments__form__submit");c=$(".lozcomments__form__cancel")}function g(){var r=document.title.replace(/\W/g,"-").toLowerCase();t=e+r+"-comments";n=new Firebase(t)}function y(e){var n="/"+e.closest("[data-comments]").data("comments"),i=t+n;r=new Firebase(i)}function b(e){var t='<figure class="lozcomments__anchor lozcomments__anchor--'+e+'">Comment<a href="#lozcomments__'+e+'"></a></figure>';return t}function w(e){var t=E(e),n=S(e),r='<div id="lozcomments__'+e+'" class="lozcomments__wrapper"><div class="lozcomments__pane">'+n+t+"</div></div>";return r}function E(e){var t='<input type="text" placeholder="Name" class="lozcomments__form__author lozcomments__form--'+e+'__author" />',n='<textarea rows="4" placeholder="Comment" class="lozcomments__form__message lozcomments__form--'+e+'__message" />',r='<input type="submit" class="lozcomments__form__submit lozcomments__form--'+e+'__submit" value="Comment" />',i='<input type="button" class="lozcomments__form__cancel lozcomments__form--'+e+'__cancel" value="Cancel" />',s='<form method="post" class="lozcomments__form lozcomments__form--'+e+'">'+t+n+r+i+"</form>";return s}function S(e){var t='<dl class="lozcomments__thread lozcomments__thread--'+e+'"></dl>';return t}function x(){s=$(window).width();for(var e=u.length-1;e>=0;e--){var t=$(u[e]).parent(".lozcomments__anchor"),n=t.offset(),r=t.siblings(".lozcomments__wrapper");n.left>s-318?r.addClass(d).removeClass(v):r.addClass(v).removeClass(d)}i=s}function T(){$(window).resize(function(){i!==$(window).width()&&x()})}function N(){n.on("child_added",function(e){e.ref().on("child_added",function(e){var t=e.val(),n="#lozcomments__"+e.ref().parent().name()+" .lozcomments__thread",r=j(t.message);$(n).append('<dt class="lozcomment__author">'+t.author+"</dt>");$(n).append('<dd class="lozcomment__message">'+r+"</dd>");_(n)})})}function C(){u.click(function(e){k(this);e.preventDefault()})}function k(e){var t=$(".lozcomments__anchor--is-selected a"),n=e.hash;if(t[0])if($(e).parent().hasClass(h)){A();M()}else{A();L(e);O(n);_(n+" .lozcomments__thread")}else{L(e);O(n);_(n+" .lozcomments__thread")}}function L(e){$(e).parent().addClass(h);$(e.hash).addClass(p)}function A(){u.parent().removeClass(h)}function O(e){M();$(e).addClass(p)}function M(){a.removeClass(p)}function _(e){$(e).stop(!0,!0).animate({scrollTop:$(e).prop("scrollHeight")},750)}function D(){l.click(function(e){y($(this));var t=$(this).siblings(".lozcomments__form__author"),n=$(this).siblings(".lozcomments__form__message"),i=t.val(),s=n.val();if(i!==""&&s!==""){t.removeClass("lozcomments__form__author--has-eror");n.removeClass("lozcomments__form__message--has-error");r.push({author:i,message:s});$(".lozcomments__form__author").val(i);n.val("")}else P(i,t,s,n);e.preventDefault()})}function P(e,t,n,r){if(e===""&&n===""){t.addClass("lozcomments__form__author--has-error");r.addClass("lozcomments__form__message--has-error")}else if(e===""){t.addClass("lozcomments__form__author--has-error");r.removeClass("lozcomments__form__message--has-error")}else if(n===""){t.removeClass("lozcomments__form__author--has-error");r.addClass("lozcomments__form__message--has-error")}}function H(){c.click(function(e){A();M();e.preventDefault()})}function B(){f.bind("mousewheel DOMMouseScroll",function(e){var t=e.originalEvent,n=t.wheelDelta||-t.detail;this.scrollTop+=(n<0?1:-1)*30;e.preventDefault()})}function j(e){var t=/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,n=/((www|(https?|ftp|file):\/\/)[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig,r=/(@([A-Za-z]+[A-Za-z0-9]+))/ig;e=e.replace(t,"$1<br />$2");e=e.replace(n,'<a href="$1" class="lozcomment__message-body__link">$1</a>');e=e.replace(r,'<mark class="lozcomment__message-body__mention">$1</mark>');return e}function F(){var e=window.location.search.substring(1).split("&");if($.inArray("lozcomments=off",e)>-1)return!1;m();x();N();C();D();H();B();T()}var e="https://blinding-fire-4499.firebaseio.com/",t,n,r,i=$(window).width(),s,o,u,a,f,l,c,h="lozcomments__anchor--is-selected",p="lozcomments__wrapper--is-active",d="lozcomments__wrapper--is-left",v="lozcomments__wrapper--is-right";return{checkSubstring:F}}();lozcomments.checkSubstring();